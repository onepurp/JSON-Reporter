<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced JSON Report Generator</title>
    
    <!-- External libraries for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --primary-color: #4A90E2; /* A slightly softer blue */
            --secondary-color: #50E3C2; /* A fresh mint green */
            --background-color: #f4f7f9;
            --text-color: #333;
            --heading-color: #1a2533;
            --card-bg: #ffffff;
            --border-color: #e1e8ed;
            --shadow-color: rgba(0, 0, 0, 0.08);
            --code-bg: #2d2d2d;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-color);
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        h1 {
            color: var(--primary-color);
            margin: 0 0 10px 0;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .file-upload-label {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-weight: 500;
        }
        .file-upload-label:hover {
            background-color: #357ABD;
        }
        #file-input {
            display: none;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            background-color: var(--secondary-color);
            color: #333;
        }
        .btn:disabled {
            background-color: #b0bec5;
            cursor: not-allowed;
            color: white;
        }
        .btn:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(80, 227, 194, 0.4);
        }
        .btn.pdf { background-color: #d32f2f; color: white;}
        .btn.pdf:not(:disabled):hover { box-shadow: 0 4px 10px rgba(211, 47, 47, 0.3); }
        .btn.md { background-color: #388e3c; color: white;}
        .btn.md:not(:disabled):hover { box-shadow: 0 4px 10px rgba(56, 142, 60, 0.3); }
        
        #filename-display {
            font-style: italic;
            color: #555;
            margin-top: 10px;
            display: block;
        }

        #report-container {
            background-color: var(--card-bg);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-color);
            border: 1px solid var(--border-color);
        }

        .placeholder {
            text-align: center;
            color: #78909c;
            padding: 50px;
            font-size: 1.2em;
        }

        /* NEW STYLES for dynamic content */
        .report-card {
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px var(--shadow-color);
            background-color: #fdfdfd;
        }
        .report-card:last-child { margin-bottom: 0; }
        
        .report-card h3, .report-section h2 {
            font-size: 1.6em;
            color: var(--heading-color);
            margin-top: 0;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
        }
        .report-section {
             margin-bottom: 25px;
        }
        
        .field-item {
            margin-bottom: 15px;
        }

        .field-item strong {
            color: var(--primary-color);
            display: block;
            margin-bottom: 3px;
        }

        .field-item a {
            color: var(--secondary-color);
            text-decoration: none;
            word-break: break-all;
        }
        .field-item a:hover {
            text-decoration: underline;
        }
        
        details {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            background-color: #f9fafb;
        }
        summary {
            font-weight: 500;
            color: var(--heading-color);
            cursor: pointer;
            list-style-type: '► ';
        }
        details[open] > summary {
            list-style-type: '▼ ';
        }
        pre {
            background-color: var(--code-bg);
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: "Fira Code", "Courier New", monospace;
        }
    </style>
</head>
<body>

    <div class="container">
        <header class="header">
            <h1>Advanced JSON Report Generator</h1>
            <p>Upload any JSON file—object or array—to generate a clean, readable report.</p>
            <div class="controls">
                <label for="file-input" class="file-upload-label">Upload JSON</label>
                <input type="file" id="file-input" accept=".json">
                <button id="btn-html" class="btn" disabled>Download HTML</button>
                <button id="btn-pdf" class="btn pdf" disabled>Download PDF</button>
                <button id="btn-md" class="btn md" disabled>Download Markdown</button>
            </div>
             <span id="filename-display"></span>
        </header>

        <div id="report-container">
            <div class="placeholder">
                <p>Your beautiful report will appear here once you upload a file.</p>
                <p>Try the `results.json` file to see the new array and collapsible content features!</p>
            </div>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('file-input');
        const reportContainer = document.getElementById('report-container');
        const btnHtml = document.getElementById('btn-html');
        const btnPdf = document.getElementById('btn-pdf');
        const btnMd = document.getElementById('btn-md');
        const filenameDisplay = document.getElementById('filename-display');

        let jsonData = null;
        let originalFilename = 'report';

        fileInput.addEventListener('change', handleFileSelect);
        btnHtml.addEventListener('click', downloadHtml);
        btnPdf.addEventListener('click', downloadPdf);
        btnMd.addEventListener('click', downloadMarkdown);
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            originalFilename = file.name.replace(/\.json$/, '');
            filenameDisplay.textContent = `File loaded: ${file.name}`;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    jsonData = JSON.parse(e.target.result);
                    renderReport();
                    toggleButtons(true);
                } catch (error) {
                    reportContainer.innerHTML = `<div class="placeholder"><p style="color:red;"><strong>Error:</strong> Invalid JSON file. Please check the format.</p><p>${error.message}</p></div>`;
                    toggleButtons(false);
                }
            };
            reader.readAsText(file);
        }

        function toggleButtons(enabled) {
            btnHtml.disabled = !enabled;
            btnPdf.disabled = !enabled;
            btnMd.disabled = !enabled;
        }
        
        function formatKey(key) {
            const result = key.replace(/([A-Z])/g, ' $1');
            return result.charAt(0).toUpperCase() + result.slice(1);
        }

        // --- MASTER HTML RENDERER (DISPATCHER) ---
        function renderReport() {
            if (!jsonData) return;
            
            if (Array.isArray(jsonData)) {
                reportContainer.innerHTML = renderArrayOfObjectsAsHtml(jsonData);
            } else if (typeof jsonData === 'object' && jsonData !== null) {
                reportContainer.innerHTML = renderSingleObjectAsHtml(jsonData);
            } else {
                reportContainer.innerHTML = `<div class="placeholder"><p>JSON content is not an object or array.</p></div>`;
            }
        }
        
        // --- Renders a single top-level object (original functionality) ---
        function renderSingleObjectAsHtml(data) {
             let html = '';
             for (const key in data) {
                html += '<div class="report-section">';
                html += `<h2>${formatKey(key)}</h2>`;
                html += renderValueAsHtml(key, data[key]);
                html += '</div>';
            }
            return html;
        }

        // --- Renders a top-level array of objects (new functionality) ---
        function renderArrayOfObjectsAsHtml(arr) {
            return arr.map((item, index) => {
                let cardHtml = '<div class="report-card">';
                const title = item.title || `Result ${index + 1}`;
                cardHtml += `<h3>${title}</h3>`;

                for (const key in item) {
                    if (key === 'title') continue; // Already used as card title
                    cardHtml += `<div class="field-item">`;
                    cardHtml += renderValueAsHtml(key, item[key]);
                    cardHtml += `</div>`;
                }
                cardHtml += '</div>';
                return cardHtml;
            }).join('');
        }
        
        // --- Renders any value, with special handling for different types/keys ---
        function renderValueAsHtml(key, value) {
            const formattedKey = formatKey(key);
            
            if (key === 'url') {
                return `<strong>${formattedKey}:</strong> <a href="${value}" target="_blank" rel="noopener noreferrer">${value}</a>`;
            }
            
            if (typeof value === 'string') {
                // If the string is very long, make it collapsible
                if (value.length > 300) {
                     return renderCollapsibleContent(formattedKey, value);
                }
                return `<strong>${formattedKey}:</strong> <span>${value.replace(/\n/g, '<br>')}</span>`;
            }
            
            if (Array.isArray(value)) {
                 if (typeof value[0] === 'string') {
                    const listItems = value.map(item => `<li>${item}</li>`).join('');
                    return `<strong>${formattedKey}:</strong> <ul>${listItems}</ul>`;
                }
                // Handle array of objects if needed in the future
            }

            if (typeof value === 'object' && value !== null) {
                // Make all nested objects collapsible
                return renderCollapsibleContent(formattedKey, JSON.stringify(value, null, 2));
            }
            
            // Default for numbers, booleans, etc.
            return `<strong>${formattedKey}:</strong> <span>${value}</span>`;
        }

        function renderCollapsibleContent(title, content) {
            return `
                <details>
                    <summary>View ${title}</summary>
                    <pre><code>${content}</code></pre>
                </details>
            `;
        }
        
        // --- DOWNLOAD/EXPORT FUNCTIONS ---

        function downloadHtml() {
            if (!jsonData) return;
            const fullHtml = `
                <!DOCTYPE html><html lang="en">
                <head><meta charset="UTF-8"><title>${originalFilename} Report</title>
                <style>${document.querySelector('style').innerHTML}</style>
                </head><body><div class="container">
                <header class="header"><h1>Report for ${originalFilename}</h1></header>
                <div id="report-container">${reportContainer.innerHTML}</div>
                </div></body></html>`;
            
            const blob = new Blob([fullHtml], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${originalFilename}.html`;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        function downloadPdf() {
            if (!jsonData) return;
            const { jsPDF } = window.jspdf;
            const content = document.getElementById('report-container');
            const allDetails = content.querySelectorAll('details');
            
            btnPdf.textContent = 'Generating...';
            btnPdf.disabled = true;

            // IMPORTANT: Open all <details> elements for full content capture
            allDetails.forEach(d => d.open = true);

            html2canvas(content, { scale: 2, useCORS: true, logging: false })
                .then(canvas => {
                    // Restore UI state by closing the details elements
                    allDetails.forEach(d => d.open = false);

                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const canvasWidth = canvas.width;
                    const canvasHeight = canvas.height;
                    const ratio = canvasWidth / canvasHeight;
                    const widthInPdf = pdfWidth - 40;
                    const heightInPdf = widthInPdf / ratio;
                    
                    let heightLeft = heightInPdf;
                    let position = 20;
                    
                    pdf.addImage(imgData, 'PNG', 20, position, widthInPdf, heightInPdf);
                    heightLeft -= (pdfHeight - 40);

                    while (heightLeft > 0) {
                        position = -(heightInPdf - heightLeft) + 20;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 20, position, widthInPdf, heightInPdf);
                        heightLeft -= (pdfHeight - 40);
                    }
                    
                    pdf.save(`${originalFilename}.pdf`);
                })
                .finally(() => {
                    btnPdf.textContent = 'Download PDF';
                    toggleButtons(true);
                });
        }
        
        function downloadMarkdown() {
             if (!jsonData) return;
             const markdown = generateMarkdown(jsonData);
             const blob = new Blob([markdown], { type: 'text/markdown' });
             const a = document.createElement('a');
             a.href = URL.createObjectURL(blob);
             a.download = `${originalFilename}.md`;
             a.click();
             URL.revokeObjectURL(a.href);
        }
        
        // --- MASTER MARKDOWN GENERATOR ---
        function generateMarkdown(data) {
            let md = `# Report: ${originalFilename}\n\n`;
            if (Array.isArray(data)) {
                md += data.map((item, index) => {
                    let cardMd = `## Result: ${item.title || `Item ${index + 1}`}\n\n`;
                    for (const key in item) {
                        if (key === 'title') continue;
                        cardMd += renderValueAsMarkdown(key, item[key]);
                    }
                    return cardMd;
                }).join('---\n\n');
            } else if (typeof data === 'object' && data !== null) {
                for (const key in data) {
                    md += `## ${formatKey(key)}\n\n`;
                    md += renderValueAsMarkdown(key, data[key], true);
                }
            }
            return md;
        }

        function renderValueAsMarkdown(key, value, isSingleObject = false) {
            const formattedKey = `**${formatKey(key)}:**`;

            if (key === 'url') {
                return `${formattedKey} [${value}](${value})\n\n`;
            }
            
            if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
                return `<details><summary>View ${formatKey(key)}</summary>\n\n\`\`\`json\n${JSON.stringify(value, null, 2)}\n\`\`\`\n\n</details>\n\n`;
            }
            
            if (Array.isArray(value) && typeof value[0] === 'string') {
                 return `${formattedKey}\n${value.map(v => `* ${v}`).join('\n')}\n\n`;
            }

            const prefix = isSingleObject ? '' : `${formattedKey} `;
            return `${prefix}${String(value)}\n\n`;
        }

    </script>
</body>
</html>
